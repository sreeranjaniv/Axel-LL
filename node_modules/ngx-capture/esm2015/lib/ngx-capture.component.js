import { Component, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { Subject } from 'rxjs';
import { take, tap } from 'rxjs/operators';
import { NgxCaptureService } from './ngx-capture.service';
export class NgxCaptureComponent {
    constructor(captureService) {
        this.captureService = captureService;
        this.resultImage = new EventEmitter();
        this.isDrawing = false;
        this.mouseStart = { x: 0, y: 0 };
        this.cropDimensions = {
            x: 0,
            y: 0,
            width: 0,
            height: 0,
        };
        this.destroy$ = new Subject();
    }
    ngOnInit() {
        setTimeout(() => {
            this.rect = this.rectangle.nativeElement;
            this.captureZone = this.overlay.nativeElement;
            if (!this.captureZone) {
                console.warn('"captureZone" is not set');
                return;
            }
            this.captureZone.onmousedown = (e) => this.startCapture(e);
            this.captureZone.onmousemove = (e) => this.drawRect(e);
            this.captureZone.onmouseup = () => this.endCapture();
        }, 2000);
    }
    startCapture(e) {
        const mouse = this.setMousePosition(e, true);
        this.isDrawing = true;
        this.cropDimensions = {
            x: mouse.x,
            y: mouse.y,
            width: 0,
            height: 0,
        };
        this.captureZone.style.cursor = 'crosshair';
    }
    drawRect(e) {
        if (this.isDrawing) {
            const mouse = this.setMousePosition(e, false);
            this.cropDimensions = {
                x: mouse.x - this.mouseStart.x < 0 ? mouse.x : this.mouseStart.x,
                y: mouse.y - this.mouseStart.y < 0 ? mouse.y : this.mouseStart.y,
                width: Math.abs(mouse.x - this.mouseStart.x),
                height: Math.abs(mouse.y - this.mouseStart.y),
            };
            this.setRectangle();
        }
    }
    setMousePosition(e, isStart = false) {
        const ev = e || window.event; // Moz || IE
        const mouse = { x: 0, y: 0 };
        if (ev.pageX) {
            // Moz
            mouse.x = ev.clientX;
            mouse.y = ev.clientY;
        }
        else if (ev.clientX) {
            // IE
            mouse.x = ev.clientX + document.body.scrollLeft;
            mouse.y = ev.clientY + document.body.scrollTop;
        }
        if (isStart) {
            this.mouseStart.x = mouse.x;
            this.mouseStart.y = mouse.y;
        }
        return mouse;
    }
    endCapture() {
        this.captureZone.style.cursor = 'default';
        this.isDrawing = false;
        this.captureService
            .getImage(this.target, false, Object.assign(Object.assign({}, this.cropDimensions), { x: this.cropDimensions.x + window.scrollX, y: this.cropDimensions.y + window.scrollY }))
            .pipe(take(1), tap((img) => {
            this.resultImage.emit(img);
        }))
            .subscribe();
        this.cropDimensions = {
            x: 0,
            y: 0,
            width: 0,
            height: 0,
        };
        this.setRectangle();
    }
    setRectangle() {
        this.rect.style.left = this.cropDimensions.x + 'px';
        this.rect.style.top = this.cropDimensions.y + 'px';
        this.rect.style.width = this.cropDimensions.width + 'px';
        this.rect.style.height = this.cropDimensions.height + 'px';
    }
}
NgxCaptureComponent.decorators = [
    { type: Component, args: [{
                selector: 'ngx-capture',
                template: `
    <ng-content></ng-content>
    <div class="overlay" #over>
      <div class="rectangle" #rect></div>
    </div>
  `,
                styles: [".overlay{top:0px;left:0px;position:fixed;width:100vw;height:100vh}.rectangle{border:1px solid #ff0000;position:absolute}\n"]
            },] }
];
NgxCaptureComponent.ctorParameters = () => [
    { type: NgxCaptureService }
];
NgxCaptureComponent.propDecorators = {
    rectangle: [{ type: ViewChild, args: ['rect', { static: true },] }],
    overlay: [{ type: ViewChild, args: ['over', { static: true },] }],
    target: [{ type: Input }],
    resultImage: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWNhcHR1cmUuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LWNhcHR1cmUvc3JjL2xpYi9uZ3gtY2FwdHVyZS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBYyxZQUFZLEVBQUUsS0FBSyxFQUFVLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdEcsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBZ0IxRCxNQUFNLE9BQU8sbUJBQW1CO0lBd0I5QixZQUFvQixjQUFpQztRQUFqQyxtQkFBYyxHQUFkLGNBQWMsQ0FBbUI7UUFsQjNDLGdCQUFXLEdBQUcsSUFBSSxZQUFZLEVBQVUsQ0FBQztRQUtuRCxjQUFTLEdBQUcsS0FBSyxDQUFDO1FBRWxCLGVBQVUsR0FBVSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDO1FBRW5DLG1CQUFjLEdBQUc7WUFDZixDQUFDLEVBQUUsQ0FBQztZQUNKLENBQUMsRUFBRSxDQUFDO1lBQ0osS0FBSyxFQUFFLENBQUM7WUFDUixNQUFNLEVBQUUsQ0FBQztTQUNWLENBQUM7UUFFRixhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztJQUV5QixDQUFDO0lBRXpELFFBQVE7UUFDTixVQUFVLENBQUMsR0FBRyxFQUFFO1lBQ2QsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQztZQUN6QyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDO1lBRTlDLElBQUksQ0FB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bEIsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQztRQUNwRCxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDO1FBQ25ELElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7UUFDekQsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztJQUM3RCxDQUFDOzs7WUF2SUYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSxhQUFhO2dCQUN2QixRQUFRLEVBQUU7Ozs7O0dBS1Q7O2FBRUY7OztZQWZRLGlCQUFpQjs7O3dCQWlCdkIsU0FBUyxTQUFDLE1BQU0sRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7c0JBQ2xDLFNBQVMsU0FBQyxNQUFNLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFO3FCQUVsQyxLQUFLOzBCQUVMLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIEVsZW1lbnRSZWYsIEV2ZW50RW1pdHRlciwgSW5wdXQsIE9uSW5pdCwgT3V0cHV0LCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyB0YWtlLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IE5neENhcHR1cmVTZXJ2aWNlIH0gZnJvbSAnLi9uZ3gtY2FwdHVyZS5zZXJ2aWNlJztcclxuXHJcbnR5cGUgUG9pbnQgPSB7XHJcbiAgeDogbnVtYmVyO1xyXG4gIHk6IG51bWJlcjtcclxufTtcclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6ICduZ3gtY2FwdHVyZScsXHJcbiAgdGVtcGxhdGU6IGBcclxuICAgIDxuZy1jb250ZW50PjwvbmctY29udGVudD5cclxuICAgIDxkaXYgY2xhc3M9XCJvdmVybGF5XCIgI292ZXI+XHJcbiAgICAgIDxkaXYgY2xhc3M9XCJyZWN0YW5nbGVcIiAjcmVjdD48L2Rpdj5cclxuICAgIDwvZGl2PlxyXG4gIGAsXHJcbiAgc3R5bGVVcmxzOiBbJy4vbmd4LWNhcHR1cmUuY29tcG9uZW50LnNjc3MnXSxcclxufSlcclxuZXhwb3J0IGNsYXNzIE5neENhcHR1cmVDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xyXG4gIEBWaWV3Q2hpbGQoJ3JlY3QnLCB7IHN0YXRpYzogdHJ1ZSB9KSByZWN0YW5nbGU6IEVsZW1lbnRSZWY7XHJcbiAgQFZpZXdDaGlsZCgnb3ZlcicsIHsgc3RhdGljOiB0cnVlIH0pIG92ZXJsYXk6IEVsZW1lbnRSZWY7XHJcblxyXG4gIEBJbnB1dCgpIHRhcmdldDogYW55O1xyXG5cclxuICBAT3V0cHV0KCkgcmVzdWx0SW1hZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcclxuXHJcbiAgcmVjdDogSFRNTEVsZW1lbnQ7XHJcbiAgY2FwdHVyZVpvbmU6IEhUTUxFbGVtZW50O1xyXG5cclxuICBpc0RyYXdpbmcgPSBmYWxzZTtcclxuXHJcbiAgbW91c2VTdGFydDogUG9pbnQgPSB7IHg6IDAsIHk6IDAgfTtcclxuXHJcbiAgY3JvcERpbWVuc2lvbnMgPSB7XHJcbiAgICB4OiAwLFxyXG4gICAgeTogMCxcclxuICAgIHdpZHRoOiAwLFxyXG4gICAgaGVpZ2h0OiAwLFxyXG4gIH07XHJcblxyXG4gIGRlc3Ryb3kkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBjYXB0dXJlU2VydmljZTogTmd4Q2FwdHVyZVNlcnZpY2UpIHt9XHJcblxyXG4gIG5nT25Jbml0KCkge1xyXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgIHRoaXMucmVjdCA9IHRoaXMucmVjdGFuZ2xlLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICAgIHRoaXMuY2FwdHVyZVpvbmUgPSB0aGlzLm92ZXJsYXkubmF0aXZlRWxlbWVudDtcclxuXHJcbiAgICAgIGlmICghdGhpcy5jYXB0dXJlWm9uZSkge1xyXG4gICAgICAgIGNvbnNvbGUud2FybignXCJjYXB0dXJlWm9uZVwiIGlzIG5vdCBzZXQnKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMuY2FwdHVyZVpvbmUub25tb3VzZWRvd24gPSAoZSkgPT4gdGhpcy5zdGFydENhcHR1cmUoZSk7XHJcbiAgICAgIHRoaXMuY2FwdHVyZVpvbmUub25tb3VzZW1vdmUgPSAoZSkgPT4gdGhpcy5kcmF3UmVjdChlKTtcclxuICAgICAgdGhpcy5jYXB0dXJlWm9uZS5vbm1vdXNldXAgPSAoKSA9PiB0aGlzLmVuZENhcHR1cmUoKTtcclxuICAgIH0sIDIwMDApO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzdGFydENhcHR1cmUoZTogYW55KSB7XHJcbiAgICBjb25zdCBtb3VzZSA9IHRoaXMuc2V0TW91c2VQb3NpdGlvbihlLCB0cnVlKTtcclxuXHJcbiAgICB0aGlzLmlzRHJhd2luZyA9IHRydWU7XHJcblxyXG4gICAgdGhpcy5jcm9wRGltZW5zaW9ucyA9IHtcclxuICAgICAgeDogbW91c2UueCxcclxuICAgICAgeTogbW91c2UueSxcclxuICAgICAgd2lkdGg6IDAsXHJcbiAgICAgIGhlaWdodDogMCxcclxuICAgIH07XHJcblxyXG4gICAgdGhpcy5jYXB0dXJlWm9uZS5zdHlsZS5jdXJzb3IgPSAnY3Jvc3NoYWlyJztcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZHJhd1JlY3QoZTogYW55KSB7XHJcbiAgICBpZiAodGhpcy5pc0RyYXdpbmcpIHtcclxuICAgICAgY29uc3QgbW91c2UgPSB0aGlzLnNldE1vdXNlUG9zaXRpb24oZSwgZmFsc2UpO1xyXG5cclxuICAgICAgdGhpcy5jcm9wRGltZW5zaW9ucyA9IHtcclxuICAgICAgICB4OiBtb3VzZS54IC0gdGhpcy5tb3VzZVN0YXJ0LnggPCAwID8gbW91c2UueCA6IHRoaXMubW91c2VTdGFydC54LFxyXG4gICAgICAgIHk6IG1vdXNlLnkgLSB0aGlzLm1vdXNlU3RhcnQueSA8IDAgPyBtb3VzZS55IDogdGhpcy5tb3VzZVN0YXJ0LnksXHJcbiAgICAgICAgd2lkdGg6IE1hdGguYWJzKG1vdXNlLnggLSB0aGlzLm1vdXNlU3RhcnQueCksXHJcbiAgICAgICAgaGVpZ2h0OiBNYXRoLmFicyhtb3VzZS55IC0gdGhpcy5tb3VzZVN0YXJ0LnkpLFxyXG4gICAgICB9O1xyXG4gICAgICB0aGlzLnNldFJlY3RhbmdsZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZXRNb3VzZVBvc2l0aW9uKGU6IGFueSwgaXNTdGFydCA9IGZhbHNlKSB7XHJcbiAgICBjb25zdCBldiA9IGUgfHwgd2luZG93LmV2ZW50OyAvLyBNb3ogfHwgSUVcclxuICAgIGNvbnN0IG1vdXNlOiBQb2ludCA9IHsgeDogMCwgeTogMCB9O1xyXG5cclxuICAgIGlmIChldi5wYWdlWCkge1xyXG4gICAgICAvLyBNb3pcclxuICAgICAgbW91c2UueCA9IGV2LmNsaWVudFg7XHJcbiAgICAgIG1vdXNlLnkgPSBldi5jbGllbnRZO1xyXG4gICAgfSBlbHNlIGlmIChldi5jbGllbnRYKSB7XHJcbiAgICAgIC8vIElFXHJcbiAgICAgIG1vdXNlLnggPSBldi5jbGllbnRYICsgZG9jdW1lbnQuYm9keS5zY3JvbGxMZWZ0O1xyXG4gICAgICBtb3VzZS55ID0gZXYuY2xpZW50WSArIGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChpc1N0YXJ0KSB7XHJcbiAgICAgIHRoaXMubW91c2VTdGFydC54ID0gbW91c2UueDtcclxuICAgICAgdGhpcy5tb3VzZVN0YXJ0LnkgPSBtb3VzZS55O1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBtb3VzZTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZW5kQ2FwdHVyZSgpIHtcclxuICAgIHRoaXMuY2FwdHVyZVpvbmUuc3R5bGUuY3Vyc29yID0gJ2RlZmF1bHQnO1xyXG4gICAgdGhpcy5pc0RyYXdpbmcgPSBmYWxzZTtcclxuXHJcbiAgICB0aGlzLmNhcHR1cmVTZXJ2aWNlXHJcbiAgICAgIC5nZXRJbWFnZSh0aGlzLnRhcmdldCwgZmFsc2UsIHtcclxuICAgICAgICAuLi50aGlzLmNyb3BEaW1lbnNpb25zLFxyXG4gICAgICAgIHg6IHRoaXMuY3JvcERpbWVuc2lvbnMueCArIHdpbmRvdy5zY3JvbGxYLFxyXG4gICAgICAgIHk6IHRoaXMuY3JvcERpbWVuc2lvbnMueSArIHdpbmRvdy5zY3JvbGxZLFxyXG4gICAgICB9KVxyXG4gICAgICAucGlwZShcclxuICAgICAgICB0YWtlKDEpLFxyXG4gICAgICAgIHRhcCgoaW1nKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLnJlc3VsdEltYWdlLmVtaXQoaW1nKTtcclxuICAgICAgICB9KVxyXG4gICAgICApXHJcbiAgICAgIC5zdWJzY3JpYmUoKTtcclxuXHJcbiAgICB0aGlzLmNyb3BEaW1lbnNpb25zID0ge1xyXG4gICAgICB4OiAwLFxyXG4gICAgICB5OiAwLFxyXG4gICAgICB3aWR0aDogMCxcclxuICAgICAgaGVpZ2h0OiAwLFxyXG4gICAgfTtcclxuICAgIHRoaXMuc2V0UmVjdGFuZ2xlKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNldFJlY3RhbmdsZSgpIHtcclxuICAgIHRoaXMucmVjdC5zdHlsZS5sZWZ0ID0gdGhpcy5jcm9wRGltZW5zaW9ucy54ICsgJ3B4JztcclxuICAgIHRoaXMucmVjdC5zdHlsZS50b3AgPSB0aGlzLmNyb3BEaW1lbnNpb25zLnkgKyAncHgnO1xyXG4gICAgdGhpcy5yZWN0LnN0eWxlLndpZHRoID0gdGhpcy5jcm9wRGltZW5zaW9ucy53aWR0aCArICdweCc7XHJcbiAgICB0aGlzLnJlY3Quc3R5bGUuaGVpZ2h0ID0gdGhpcy5jcm9wRGltZW5zaW9ucy5oZWlnaHQgKyAncHgnO1xyXG4gIH1cclxufVxyXG4iXX0=